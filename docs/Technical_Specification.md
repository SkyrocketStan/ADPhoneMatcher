# Техническое задание: ADPhoneMatcher

## 1. Введение

**ADPhoneMatcher** — это приложение для сопоставления телефонных номеров из CSV-выгрузки Active Directory (AD) с данными из выгрузок (`.csv` или `.txt`). Проект работает на чистом Python без сторонних библиотек, автоматизирует обработку данных, создаёт структурированные CSV-отчёты, архивирует файлы и ведёт подробное логирование. Разработан для корпоративной среды Linux.

### 1.1. Цели проекта

- Автоматизировать сопоставление номеров из AD-выгрузки с выгрузками.
- Обеспечить читаемый консольный вывод и подробные логи.
- Гарантировать надёжность, производительность и безопасность (права `0o666`).
- Создать анонимизированную документацию для публикации на GitHub.

### 1.2. Аудитория

- Системные администраторы: работа с входными данными.
- Разработчики: доработка и интеграция.
- Нетехнические пользователи: понимание результатов.

## 2. Функциональные требования

### 2.1. Обработка входных данных

- **Входной файл**:
  - Формат: CSV, разделитель `;` (настраивается в `config.py`).
  - Поля: `name`, `phone` (множественные номера, разделённые `;` или `#`), `email`, `active` (настраиваются в `config.py`).
  - Пример:

    ```
    name,phone,email,active
    [NAME],[PHONE];[PHONE2],[EMAIL],True
    ```

- **Выгрузки**:
  - Формат: `.csv` (разделитель `,`) или `.txt`.
  - Поля: столбцы с номерами (`number`, `phone`, и т.д.).
  - Папка: `input/`, исключая `output/` и `archive/`.

### 2.2. Нормализация номеров

- Удаление символов `+-() " "` (настраивается в `config.py`).
- Пример: `[PHONE_FORMATTED]` → `[PHONE_NORMALIZED]`.

### 2.3. Сопоставление

- Сравнение нормализованных номеров из AD-выгрузки и выгрузок.
- Вывод совпадений в CSV с полями:
  - `phone` (телефон),
  - `name` (имя),
  - `email` (почта),
  - `active` (статус).

### 2.4. Вывод

- Формат: CSV, разделитель `,` (настраивается в `config.py`).
- Папка: `output/`.
- Имя: `output_YYYY-MM-DD_HH-MM-SS.csv`.
- Права: `0o666`.

### 2.5. Логирование

- **Логи**:
  - Папка: `logs/`.
  - Имя: `log_YYYY-MM-DD_HH-MM-SS.log`.
  - Максимум: 5 файлов (настраивается в `config.py`).
  - Формат: `[YYYY-MM-DD HH:MM:SS] message`.
  - Уровень: `DEBUG`, абсолютные пути (`[BASE_DIR]/...`).
- **Консоль**:
  - Относительные пути (`./input/...`).
  - Уровень: `INFO` без `-v`, `DEBUG` с `-v`.

### 2.6. Архивирование

- Перемещение обработанных выгрузок в `archive/`.
- Уникальные имена (например, `file_1.csv` при конфликте).

### 2.7. Производительность

- Обработка `[N]` номеров за 0 секунд.
- Минимизация операций ввода-вывода.

## 3. Нефункциональные требования

- **Среда**: Python 3.7+, корпоративная Linux (тестировалось на Astra Linux и Linux Mint).
- **Зависимости**: Отсутствуют, проект использует только стандартную библиотеку Python.
- **Права доступа**: `0o666` для CSV и логов.
- **Кодировки**: Поддержка `utf-8`, `windows-1251`, и т.д.
- **Документация**: Markdown, анонимизированная, для GitHub.
- **Масштабируемость**: Поддержка новых источников данных.
- **Безопасность**: Анонимизация всех данных.

## 4. Структура проекта

| Папка/Файл                        | Описание                        |
|-----------------------------------|---------------------------------|
| `logs/`                           | Логи (`log_*.log`, до 5 файлов) |
| `phone_matcher/`                  | Пакет Python                    |
| `phone_matcher/__init__.py`       | Инициализация пакета            |
| `phone_matcher/main.py`           | Точка входа                     |
| `phone_matcher/utils.py`          | Утилиты (логирование, пути)     |
| `phone_matcher/config.py`         | Конфигурация                    |
| `phone_matcher/parse_ad.py`       | Парсинг входного файла          |
| `phone_matcher/normalize.py`      | Нормализация номеров            |
| `phone_matcher/parse_phone.py`    | Парсинг номеров                 |
| `phone_matcher/output.py`         | Формирование CSV                |
| `phone_matcher/match.py`          | Сопоставление номеров           |
| `input/`                          | Входные выгрузки                |
| `output/`                         | Выходные CSV                    |
| `archive/`                        | Архив обработанных файлов       |
| `docs/Technical_Specification.md` | Техническое задание             |
| `.gitignore`                      | Игнорируемые файлы              |
| `README.md`                       | Основная документация           |
| `LICENSE`                         | Лицензия (MIT)                  |
| `CHANGELOG.md`                    | История изменений               |
| `CONTRIBUTING.md`                 | Инструкции для контрибьюторов   |
| `run.sh`                          | Скрипт запуска                  |

## 5. Зависимости

Проект работает на чистом Python без использования сторонних библиотек.

## 6. Риски и ограничения

| Риск                               | Вероятность | Последствия      | Меры                           |
|------------------------------------|-------------|------------------|--------------------------------|
| Некорректный формат входного файла | Средняя     | Ошибка обработки | Валидация данных               |
| Проблемы с кодировкой              | Низкая      | Ошибка чтения    | Поддержка нескольких кодировок |
| Конфликты имён в `archive/`        | Низкая      | Потеря данных    | Уникальные имена файлов        |
| Нагрузка на диск при логах         | Низкая      | Замедление       | Ограничение количества логов   |

## 7. План тестирования

- **Модульные тесты**:
  - `parse_ad.py`: Проверка парсинга CSV.
  - `normalize.py`: Тесты нормализации номеров.
  - `parse_phone.py`: Проверка парсинга номеров.
  - `match.py`: Тесты сопоставления.
  - `utils.py`: Проверка логирования.
- **Интеграционные тесты**:
  - Полный цикл: входной файл → выгрузки → CSV → архив → логи.
- **Ручное тестирование**:
  - Запуск с `-v` и без.
  - Проверка прав (`0o666`), кодировок, производительности.
