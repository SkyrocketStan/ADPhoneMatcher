# Техническое задание: ADPhoneMatcher

## 1. Введение

**ADPhoneMatcher** — это приложение для сопоставления телефонных номеров из CSV-выгрузки Active Directory (AD) с данными из выгрузок (`.csv` или `.txt`). Проект работает на чистом Python без сторонних библиотек, автоматизирует обработку данных, создаёт структурированные CSV-отчёты, архивирует файлы и ведёт подробное логирование. Разработан для корпоративной среды Linux.

### 1.1. Цели проекта

- Автоматизировать сопоставление номеров из AD-выгрузки с выгрузками.
- Обеспечить читаемый консольный вывод и подробные логи.
- Гарантировать надёжность, производительность и безопасность (права `0o666`).
- Создать анонимизированную документацию для публикации на GitHub.

### 1.2. Аудитория

- Системные администраторы: работа с входными данными.
- Разработчики: доработка и интеграция.
- Нетехнические пользователи: понимание результатов.

## 2. Функциональные требования

### 2.1. Обработка входных данных

- **Входной файл**:
  - Формат: CSV, разделитель `;` (настраивается в `config.py`).
  - Поля: `name`, `phone` (множественные номера, разделённые `;` или `#`), `email`, `active` (настраиваются в `config.py`).
  - Папка: `data/ad_input/`.
  - Пример:

    ```csv
    name,phone,email,active
    Пользователь Иван Иванов,123456;789012,ivan.ivanov@company.com,True
    ```

  - **Проверка аномалий в telephoneNumber**:
    - Номера проверяются после нормализации (удаление `+-() " "`) на:
      - Длину: минимум `VALID_PHONE_NUMBER_LENGTH` цифр (по умолчанию 6, настраивается в `config.py`).
      - Содержание: только цифры, отсутствие букв или иных символов.
    - Пустое поле `telephoneNumber` считается штатным и не логируется.
    - Аномалии (например, `XX123` или `12345`) записываются в лог `logs/anomalies_YYYY-MM-DD_HH-MM-SS.log` с полной строкой AD. Пример:

      ```plaintext
      [2025-04-26 12:00:00] Некорректный номер в строке: "Петрова Анна";"XX123;12345";"anna.petрова@company.com";"False"
      ```

    - Общее количество аномалий выводится в консоль и основной лог на уровне INFO:

      ```plaintext
      [2025-04-26 12:00:00] Обнаружено аномалий в номерах AD: X
      ```

- **Выгрузки**:
  - Формат: `.csv` (разделитель `,`) или `.txt`.
  - Поля: столбцы с номерами (`number`, `phone`, и т.д.).
  - Папка: `data/phone_data/`, исключая `data/results/` и `data/archive/`.

### 2.2. Нормализация номеров

- Удаление символов `+-() " "` (настраивается в `config.py`).
- Пример: `+7(123)456` → `123456`.

### 2.3. Сопоставление

- Сравнение нормализованных номеров из AD-выгрузки и выгрузок.
- Вывод совпадений в CSV с полями:
  - `phone` (телефон),
  - `name` (имя),
  - `email` (почта),
  - `active` (статус).

### 2.4. Вывод

- Формат: CSV, разделитель `,` (настраивается в `config.py`).
- Папка: `data/results/`.
- Имя: `output_YYYY-MM-DD_HH-MM-SS.csv`.
- Права: `0o666`.

### 2.5. Логирование

- **Логи**:
  - Папка: `logs/`.
  - Имя: `log_YYYY-MM-DD_HH-MM-SS.log`.
  - Максимум: 5 файлов (настраивается в `config.py`).
  - Формат: `[YYYY-MM-DD HH:MM:SS] message`.
  - Уровень: `DEBUG`, абсолютные пути (`[BASE_DIR]/...`).
- **Лог аномалий**:
  - Папка: `logs/`.
  - Имя: `anomalies_YYYY-MM-DD_HH-MM-SS.log`.
  - Максимум: 5 файлов (настраивается в `config.py`).
  - Формат: `[YYYY-MM-DD HH:MM:SS] Некорректный номер в строке: [строка AD]`.
  - Права: `0o666`.
- **Консоль**:
  - Относительные пути (`./data/ad_input/...`).
  - Уровень: `INFO` без `-v`, `DEBUG` с `-v`.
  - Вывод количества аномалий: `[YYYY-MM-DD HH:MM:SS] Обнаружено аномалий в номерах AD: X`.

### 2.6. Архивирование

- Перемещение обработанных выгрузок в `data/archive/`.
- Уникальные имена (например, `file_1.csv` при конфликте).

### 2.7. Производительность

- Обработка `[N]` номеров за 0 секунд.
- Минимизация операций ввода-вывода.

## 3. Нефункциональные требования

- **Среда**: Python 3.7+, корпоративная Linux (тестировалось на Astra Linux и Linux Mint).
- **Зависимости**: Отсутствуют, проект использует только стандартную библиотеку Python.
- **Контейнеризация**: Поддержка запуска в Podman с образом `python:3.7-slim` для воспроизводимости.
- **Очистка окружения**: Удаление виртуального окружения (`.venv/`) перед запуском в Podman.
- **Права доступа**: `0o666` для CSV и логов.
- **Кодировки**: Поддержка `utf-8`, `windows-1251`, и т.д.
- **Документация**: Markdown, анонимизированная, для GitHub.
- **Масштабируемость**: Поддержка новых источников данных.
- **Безопасность**: Анонимизация всех данных.

## 4. Структура проекта

| Папка/Файл                        | Описание                        |
|-----------------------------------|---------------------------------|
| `logs/`                           | Логи (`log_*.log`, `anomalies_*.log`, до 5 файлов) |
| `phone_matcher/`                  | Пакет Python                    |
| `phone_matcher/__init__.py`       | Инициализация пакета            |
| `phone_matcher/main.py`           | Точка входа                     |
| `phone_matcher/utils.py`          | Утилиты (логирование, пути)     |
| `phone_matcher/config.py`         | Конфигурация                    |
| `phone_matcher/parse_ad.py`       | Парсинг входного файла          |
| `phone_matcher/normalize.py`      | Нормализация номеров            |
| `phone_matcher/parse_phone.py`    | Парсинг номеров                 |
| `phone_matcher/output.py`         | Формирование CSV                |
| `phone_matcher/match.py`          | Сопоставление номеров           |
| `data/ad_input/`                  | Входной файл AD                 |
| `data/phone_data/`                | Файлы выгрузок номеров          |
| `data/results/`                   | Выходные CSV                    |
| `data/archive/`                   | Архив обработанных файлов       |
| `docs/Technical_Specification.md` | Техническое задание             |
| `scripts/`                        | Утилиты для развертывания       |
| `scripts/run-podman.sh`           | Запуск в Podman                 |
| `scripts/run-tests-podman.sh`     | Тесты в Podman                  |
| `.gitignore`                      | Игнорируемые файлы              |
| `README.md`                       | Основная документация           |
| `LICENSE`                         | Лицензия (MIT)                  |
| `CHANGELOG.md`                    | История изменений               |
| `CONTRIBUTING.md`                 | Инструкции для контрибьюторов   |
| `run.sh`                          | Скрипт запуска                  |

## 5. Зависимости

Проект работает на чистом Python без использования сторонних библиотек. Для тестирования и линтинга в CI или Podman:

- `pytest`: Для юнит-тестов.
- `pylint`: Для проверки кода.

## 6. Риски и ограничения

| Риск                               | Вероятность | Последствия      | Меры                           |
|------------------------------------|-------------|------------------|--------------------------------|
| Некорректный формат входного файла | Средняя     | Ошибка обработки | Валидация данных               |
| Проблемы с кодировкой              | Низкая      | Ошибка чтения    | Поддержка нескольких кодировок |
| Конфликты имён в `archive/`        | Низкая      | Потеря данных    | Уникальные имена файлов        |
| Нагрузка на диск при логах         | Низкая      | Замедление       | Ограничение количества логов   |
| Отсутствие Podman                  | Низкая      | Ошибка запуска   | Документация по установке      |

## 7. План тестирования

- **Модульные тесты**:
  - `parse_ad.py`: Проверка парсинга CSV и аномалий.
  - `normalize.py`: Тесты нормализации номеров.
  - `parse_phone.py`: Проверка парсинга номеров.
  - `match.py`: Тесты сопоставления.
  - `utils.py`: Проверка логирования.
- **Интеграционные тесты**:
  - Полный цикл: входной файл → выгрузки → CSV → архив → логи.
- **Ручное тестирование**:
  - Запуск с `-v` и без.
  - Проверка прав (`0o666`), кодировок, производительности.
- **Тестирование в Podman**:
  - Запуск тестов и линтера в контейнере через `run-tests-podman.sh`.
